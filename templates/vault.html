<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G.E.M.S. - Fingerprint Edition</title>
    <style>
        :root { --bg: #121212; --fg: #e0e0e0; --accent: #00ff9d; --panel: #1e1e1e; }
        body { background: var(--bg); color: var(--fg); font-family: 'Consolas', monospace; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { width: 100%; max-width: 420px; background: var(--panel); padding: 25px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); border: 1px solid #333; }
        h2 { margin-top: 0; color: var(--accent); border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        .group { margin-bottom: 15px; position: relative; }
        label { display: block; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        input, select { width: 100%; background: #2a2a2a; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 4px; outline: none; box-sizing: border-box; font-family: inherit; }
        input:focus { border-color: var(--accent); }
        
        /* 指纹徽章样式 */
        .fingerprint-badge {
            position: absolute;
            right: 10px;
            top: 32px; /* Align with input */
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        button { width: 100%; background: var(--accent); color: #000; border: none; padding: 12px; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 10px; font-size: 1rem; }
        #output { margin-top: 20px; padding: 15px; background: #000; border: 1px dashed #444; color: var(--accent); font-size: 1.1rem; text-align: center; word-break: break-all; cursor: pointer; }
        
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; opacity: 0; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

<div class="container">
    <h2>Stateless Vault</h2>
    
    <div class="group">
        <label>MASTER KEY</label>
        <input type="password" id="mk" placeholder="Passphrase..." autocomplete="off">
        <div id="mk-fingerprint" class="fingerprint-badge">????</div>
    </div>

    <div class="group">
        <label>PLATFORM</label>
        <input type="text" id="site" placeholder="e.g. Google" list="aliases">
        <datalist id="aliases">
            <option value="Google">google</option>
        </datalist>
    </div>

    <div class="group" style="display:flex; gap:10px;">
        <div style="flex:1"><label>LEN</label><input type="number" id="len" value="16"></div>
        <div style="flex:1">
            <label>MODE</label>
            <select id="mode">
                <option value="std">Standard</option>
                <option value="nosym">NoSymbol</option>
            </select>
        </div>
    </div>

    <button id="gen-btn">Generate</button>
    <div id="output">READY</div>
</div>
<div id="toast" class="toast">Copied</div>

<script>
    const BASE62 = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
    const SYMBOLS = "!@#%_-+";
    const ALIAS_MAP = {
        "工行": {code:"icbc", mode:"nosym"}, 
        "icbc": {code:"icbc", mode:"nosym"},
        "b站": {code:"bilibili"}
    };

    const mkInput = document.getElementById('mk');
    const fpBadge = document.getElementById('mk-fingerprint');

    mkInput.addEventListener('input', async () => {
        const val = mkInput.value;
        if (val.length === 0) {
            fpBadge.style.opacity = '0';
            return;
        }

        const enc = new TextEncoder();
        const hashBuffer = await crypto.subtle.digest('SHA-256', enc.encode(val));
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        
        const r = hashArray[0];
        const g = hashArray[1];
        const b = hashArray[2];
        
        const code = hashArray.slice(0, 2).map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
      
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        const textColor = brightness > 128 ? '#000' : '#fff';

        fpBadge.innerText = code;
        fpBadge.style.backgroundColor = `rgb(${r},${g},${b})`;
        fpBadge.style.color = textColor;
        fpBadge.style.opacity = '1';
    });

    async function generate() {
        const mk = mkInput.value;
        let site = document.getElementById('site').value.trim();
        let mode = document.getElementById('mode').value;
        
        if(!mk || !site) return;

        // 别名处理
        const lower = site.toLowerCase();
        if(ALIAS_MAP[lower]) {
            site = ALIAS_MAP[lower].code;
            if(ALIAS_MAP[lower].mode) mode = ALIAS_MAP[lower].mode;
        } else {
            site = lower.replace(/\s+/g, '').replace(/\.(com|cn|net)$/,'');
        }

        const enc = new TextEncoder();
        const keyData = await crypto.subtle.importKey("raw", enc.encode(mk), {name:"HMAC", hash:"SHA-256"}, false, ["sign"]);
        const signature = await crypto.subtle.sign("HMAC", keyData, enc.encode(site));
        const digest = new Uint8Array(signature);

        let chars = Array.from(digest).map(b => BASE62[b % 62]);
        chars[0] = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[digest[0]%26];
        chars[1] = "abcdefghijklmnopqrstuvwxyz"[digest[1]%26];
        chars[2] = "0123456789"[digest[2]%10];
        if(mode === 'std') chars[3] = SYMBOLS[digest[3]%SYMBOLS.length];

        const pwd = chars.join('').substring(0, document.getElementById('len').value);
        
        const out = document.getElementById('output');
        out.innerText = pwd;
        out.onclick = () => {
            navigator.clipboard.writeText(pwd);
            const t = document.getElementById('toast');
            t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 2000);
        };
    }

    document.getElementById('gen-btn').onclick = generate;
</script>
</body>
</html>
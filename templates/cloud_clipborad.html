<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>云剪贴板 (localStorage版)</title>
    <style>
        /* CSS 样式保持不变 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .container {
            width: 90%;
            max-width: 600px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        textarea {
            width: 100%;
            min-height: 200px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            font-size: 14px;
            resize: vertical;
        }
        .controls {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        button {
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            flex-grow: 1;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button#setKey {
            background-color: #28a745;
        }
        button#setKey:hover {
            background-color: #218838;
        }
        .status {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>

    <div class="container">
        <textarea id="clipboardContent" placeholder="在此输入内容..."></textarea>
        <div class="controls">
            <button id="setKey">设置访问密钥</button>
            <button id="writeClip">写入剪贴板</button>
            <button id="syncClip">从剪贴板同步</button>
        </div>
        <div id="statusMessage" class="status"></div>
    </div>

    <script>
        console.log("脚本初始化 (localStorage 版本)。");

        // $HOST$ 替换逻辑保持不变, 但要注意 file:// 协议下的 fetch 同样会因 CORS 失败
        // 除非您的服务器 ( $HOST$ ) 明确允许了 'Origin: null'
        const API_URL = `/clipboard/api`;
        
        // 我们使用 localStorage 的 key 来代替 Cookie 名称
        const STORAGE_KEY = 'auth_token';
        console.log(`API URL: ${API_URL}, Storage Key: ${STORAGE_KEY}`);

        // 获取 DOM 元素
        const contentBox = document.getElementById('clipboardContent');
        const setKeyBtn = document.getElementById('setKey');
        const writeClipBtn = document.getElementById('writeClip');
        const syncClipBtn = document.getElementById('syncClip');
        const statusMsg = document.getElementById('statusMessage');

        function setStorageKey(name, value) {
            console.log(`[setStorageKey] 尝试设置 (Cookie): key=${name}, value=${value}`);
            try {
                const date = new Date();
                date.setTime(date.getTime() + (36500 * 24 * 60 * 60 * 1000));
                const expires = "; expires=" + date.toUTCString();
                document.cookie = `${name}=${encodeURIComponent(value || "")}${expires}; path=/;`;
                console.log(`[setStorageKey] document.cookie 写入操作执行完毕。`);
                // 验证是否写入成功（部分浏览器在隐私模式下可能静默失败）
                if (getStorageKey(name) !== null) {
                     showStatus(`密钥已设置 (Cookie)`, 'success');
                } else {
                     throw new Error("写入后无法读取，可能是浏览器禁用了 Cookie");
                }

            } catch (e) {
                console.error("[setStorageKey] 写入 Cookie 失败:", e);
                showStatus(`密钥设置失败: ${e.message}`, 'error');
            }
        }
        function getStorageKey(name) {
            console.log(`[getStorageKey] 尝试获取 (Cookie): key=${name}`);
            try {
                const nameEQ = name + "=";
                const ca = document.cookie.split(';');
                for(let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    // 移除前导空格
                    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                    // 匹配键名
                    if (c.indexOf(nameEQ) === 0) {
                        const rawValue = c.substring(nameEQ.length, c.length);
                        const value = decodeURIComponent(rawValue);
                        console.log(`[getStorageKey] Cookie 匹配成功:`, value);
                        return value;
                    }
                }
                console.log(`[getStorageKey] 未找到指定 Cookie，返回 null`);
                return null;
            } catch (e) {
                console.error("[getStorageKey] 读取 Cookie 失败:", e);
                showStatus(`密钥读取失败: ${e.message}`, 'error');
                return null;
            }
        }
        /**
         * 在状态区域显示消息
         */
        function showStatus(message, type = 'info') {
            console.log(`[showStatus] 类型: ${type}, 消息: ${message}`);
            statusMsg.textContent = message;
            if (type === 'success') {
                statusMsg.style.color = '#28a745';
            } else if (type === 'error') {
                statusMsg.style.color = '#dc3545';
            } else {
                statusMsg.style.color = '#666';
            }
        }

        // 按钮1: 设置访问密钥
        setKeyBtn.addEventListener('click', () => {
            console.log("--- '设置访问密钥' 按钮点击 ---");
            const key = contentBox.value.trim();
            console.log(`输入框内容 (trim后): "${key}"`);
            
            if (key) {
                // 调用修改后的函数
                setStorageKey(STORAGE_KEY, key);
            } else {
                showStatus('请输入密钥到输入框中再设置', 'error');
                console.warn("[setKeyBtn] 密钥为空，未设置。");
            }
        });

        // 按钮2: 写入剪贴板 (PUT)
        writeClipBtn.addEventListener('click', async () => {
            console.log("--- '写入剪贴板' 按钮点击 ---");
            // 调用修改后的函数
            const password = getStorageKey(STORAGE_KEY);
            
            console.log(`[writeClipBtn] 获取到的 password:`, password);

            if (!password) {
                showStatus('错误: 未设置访问密钥 (请先设置)', 'error');
                console.error("[writeClipBtn] 检查失败：password 为空或 null。");
                return;
            }

            console.log("[writeClipBtn] 密钥检查通过。");
            const content = contentBox.value;
            showStatus('正在写入...', 'info');
            console.log(`[writeClipBtn] 准备发送PUT请求, 内容长度: ${content.length}`);

            try {
                const response = await fetch(API_URL, {
                    method: 'PUT',
                    credentials: 'same-origin',
                    body: content
                });

                console.log(`[writeClipBtn] 收到响应: status=${response.status}`);
                if (response.ok) {
                    showStatus('写入成功', 'success');
                } else {
                    showStatus(`写入失败: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                console.error('[writeClipBtn] 请求捕获到异常:', error);
                showStatus(`写入请求失败: ${error.message}`, 'error');
            }
        });

        // 按钮3: 从剪贴板同步 (GET)
        syncClipBtn.addEventListener('click', async () => {
            console.log("--- '从剪贴板同步' 按钮点击 ---");
            // 调用修改后的函数
            const password = getStorageKey(STORAGE_KEY);
            
            console.log(`[syncClipBtn] 获取到的 password:`, password);

            if (!password) {
                showStatus('错误: 未设置访问密钥 (请先设置)', 'error');
                console.error("[syncClipBtn] 检查失败：password 为空或 null。");
                return;
            }

            console.log("[syncClipBtn] 密钥检查通过。");
            showStatus('正在同步...', 'info');
            console.log("[syncClipBtn] 准备发送GET请求。");

            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                console.log(`[syncClipBtn] 收到响应: status=${response.status}`);
                if (response.ok) {
                    const data = await response.text();
                    contentBox.value = data;
                    showStatus('同步成功', 'success');
                    console.log(`[syncClipBtn] 同步内容长度: ${data.length}`);
                } else {
                    showStatus(`同步失败: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error)
             {
                console.error('[syncClipBtn] 请求捕获到异常:', error);
                showStatus(`同步请求失败: ${error.message}`, 'error');
            }
        });

    </script>

</body>
</html>
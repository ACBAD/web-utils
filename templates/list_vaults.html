<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G.E.M.S. - Configuration Registry</title>
    <link rel="stylesheet" href="/src/vault.css">
    <style>
        /* 针对表格页面的补充样式 */
        .container {
            max-width: 800px; /*稍微宽一点以容纳表格*/
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
            color: #333;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #eee;
            color: white;
        }
        th {
            background-color: darkolivegreen;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }
        tr:hover {
            background-color: gray;
        }
        /* 符号列样式：截断过长文本 */
        .col-sym {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: monospace;
            color: #555;
        }
        .tag-nosym {
            color: #999;
            font-style: italic;
            font-size: 12px;
        }
        /* 按钮样式微调 */
        .btn-del {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        .btn-del:hover {
            background-color: #c0392b;
        }
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        a.nav-link {
            text-decoration: none;
            color: #2c3e50;
            font-weight: bold;
            font-size: 14px;
        }
        a.nav-link:hover {
            text-decoration: underline;
        }
        /* 简单的加载状态 */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-actions">
        <h2>Config Registry</h2>
        <a href="/vault" class="nav-link">← Back to Vault</a>
    </div>

    <div id="status-msg" class="loading">Loading configurations...</div>

    <table id="config-table" style="display:none;">
        <thead>
            <tr>
                <th>Alias Name</th>
                <th>Platform (Salt)</th>
                <th>Len</th>
                <th>Symbols</th>
                <th style="text-align: right;">Action</th>
            </tr>
        </thead>
        <tbody id="table-body">
            </tbody>
    </table>
</div>

<script>
    const CONFIG_API_ENDPOINT = '/vault/api/key_configs';
    // 页面加载完成后立即获取数据
    document.addEventListener('DOMContentLoaded', loadConfigs);
    async function loadConfigs() {
        const table = document.getElementById('config-table');
        const status = document.getElementById('status-msg');
        const tbody = document.getElementById('table-body');
        try {
            const response = await fetch(CONFIG_API_ENDPOINT);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            /**
             * @type {Object.<string, {symbols: ?string, length: number, platform: string}>}
             */
            const data = await response.json();
            const keys = Object.keys(data).sort(); // 按字母排序
            if (keys.length === 0) {
                status.innerText = "No configurations found.";
                return;
            }
            tbody.innerHTML = ''; // 清空旧数据
            Object.entries(data).map(([name, config]) => {
                const tr = document.createElement('tr');
                // 处理 Symbols 显示逻辑
                let symDisplay;
                if (!config.symbols) {
                    symDisplay = '<span class="tag-nosym">No Symbols</span>';
                } else {
                    symDisplay = `<span title="${config.symbols}">${config.symbols}</span>`;
                }
                tr.innerHTML = `
                    <td style="font-weight:500;">${escapeHtml(name)}</td>
                    <td>${escapeHtml(config.platform)}</td>
                    <td>${config.length}</td>
                    <td class="col-sym">${symDisplay}</td>
                    <td style="text-align: right;">
                        <button class="btn-del" onclick="deleteConfig('${escapeHtml(name)}', this)">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            })
            status.style.display = 'none';
            table.style.display = 'table';

        } catch (e) {
            console.error(e);
            status.innerText = `Error loading data: ${e.message}`;
            status.style.color = 'red';
        }
    }

    async function deleteConfig(name, btnElement) {
        if (!confirm(`Are you sure you want to delete "${name}"?`)) return;

        // 简单的 UI 锁定
        const originalText = btnElement.innerText;
        btnElement.innerText = '...';
        btnElement.disabled = true;

        try {
            const response = await fetch(`${CONFIG_API_ENDPOINT}/${encodeURIComponent(name)}`, {
                method: 'DELETE'
            });

            if (!response.ok) throw new Error(response.statusText);

            // 成功后，直接移除该行 DOM，无需重载
            const row = btnElement.closest('tr');
            row.style.background = '#ffdede'; // 视觉反馈
            setTimeout(() => row.remove(), 300);

        } catch (e) {
            alert(`Delete failed: ${e.message}`);
            btnElement.innerText = originalText;
            btnElement.disabled = false;
        }
    }

    // 简单的 XSS 防御工具
    function escapeHtml(text) {
        if (!text) return text;
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>

</body>
</html>